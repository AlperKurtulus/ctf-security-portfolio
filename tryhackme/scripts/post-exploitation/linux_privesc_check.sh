#!/bin/bash

#############################################
# Linux Privilege Escalation Enumeration Script
# Author: Alper Kurtulus (TheJker)
# Description: Comprehensive Linux privilege escalation checker
# Usage: ./linux_privesc_check.sh
#############################################

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
print_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║     Linux Privilege Escalation Enumeration Script        ║"
    echo "║                  Author: TheJker                          ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Print section header
section_header() {
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  $1${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# Print finding
finding() {
    echo -e "${GREEN}[+]${NC} $1"
}

# Print warning
warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

# Print critical
critical() {
    echo -e "${RED}[✗]${NC} $1"
}

# Print info
info() {
    echo -e "${CYAN}[i]${NC} $1"
}

print_banner

info "Starting enumeration: $(date)"
info "Hostname: $(hostname)"
echo ""

#############################################
# SYSTEM INFORMATION
#############################################

section_header "SYSTEM INFORMATION"

finding "Operating System:"
cat /etc/os-release 2>/dev/null | grep "PRETTY_NAME" | cut -d'"' -f2 || echo "Unknown"

finding "Kernel Version:"
uname -a

finding "Architecture:"
uname -m

finding "CPU Information:"
lscpu | grep "Model name" | cut -d':' -f2 | xargs

finding "Available shells:"
cat /etc/shells 2>/dev/null

#############################################
# USER & GROUP INFORMATION
#############################################

section_header "USER & GROUP INFORMATION"

finding "Current user: $(whoami)"
finding "User ID: $(id)"

finding "Users with login shells:"
cat /etc/passwd | grep -v "nologin\|false" | cut -d':' -f1,7

finding "Users with UID 0 (root):"
awk -F: '($3 == "0") {print}' /etc/passwd

finding "Current user groups:"
groups

finding "Users currently logged in:"
w 2>/dev/null || who 2>/dev/null

finding "Last logged in users:"
last -a 2>/dev/null | head -n 20

finding "Home directories:"
ls -la /home 2>/dev/null

#############################################
# SUDO PRIVILEGES
#############################################

section_header "SUDO PRIVILEGES"

finding "Checking sudo version:"
sudo -V 2>/dev/null | head -n 1

warning "Sudo permissions for current user:"
sudo -l 2>/dev/null || echo "Cannot check sudo permissions (try running as target user)"

finding "Sudoers file location:"
ls -la /etc/sudoers 2>/dev/null

finding "Sudoers.d directory:"
ls -la /etc/sudoers.d/ 2>/dev/null

#############################################
# SUID/SGID BINARIES
#############################################

section_header "SUID/SGID BINARIES"

critical "SUID binaries (potential privesc vectors):"
find / -perm -4000 -type f 2>/dev/null | while read file; do
    echo "  $file"
done

critical "SGID binaries:"
find / -perm -2000 -type f 2>/dev/null | head -n 20

warning "Writable SUID binaries (HIGH RISK):"
find / -perm -4000 -type f -writable 2>/dev/null

#############################################
# WRITABLE FILES & DIRECTORIES
#############################################

section_header "WRITABLE FILES & DIRECTORIES"

critical "World-writable directories:"
find / -type d -perm -002 2>/dev/null | grep -v "proc\|sys\|run" | head -n 20

critical "World-writable files:"
find / -type f -perm -002 2>/dev/null | grep -v "proc\|sys\|run" | head -n 20

warning "Files owned by current user outside home:"
find / -user $(whoami) 2>/dev/null | grep -v "proc\|sys\|run\|home/$(whoami)" | head -n 20

warning "Writable /etc/passwd or /etc/shadow:"
ls -la /etc/passwd /etc/shadow 2>/dev/null

#############################################
# CRON JOBS
#############################################

section_header "CRON JOBS"

finding "System-wide cron jobs:"
ls -la /etc/cron* 2>/dev/null

finding "User cron jobs:"
crontab -l 2>/dev/null || echo "No crontab for current user"

finding "Cron directory contents:"
cat /etc/crontab 2>/dev/null
ls -la /var/spool/cron/crontabs/ 2>/dev/null

critical "Writable cron jobs:"
find /etc/cron* -type f -writable 2>/dev/null

#############################################
# NETWORK INFORMATION
#############################################

section_header "NETWORK INFORMATION"

finding "Network interfaces:"
ip addr 2>/dev/null || ifconfig 2>/dev/null

finding "Network connections:"
netstat -tunlp 2>/dev/null || ss -tunlp 2>/dev/null

finding "ARP table:"
arp -a 2>/dev/null || ip neigh 2>/dev/null

finding "Listening ports:"
netstat -tulnp 2>/dev/null | grep LISTEN || ss -tulnp 2>/dev/null | grep LISTEN

finding "DNS servers:"
cat /etc/resolv.conf 2>/dev/null

finding "Hosts file:"
cat /etc/hosts 2>/dev/null

#############################################
# RUNNING PROCESSES
#############################################

section_header "RUNNING PROCESSES"

finding "Processes running as root:"
ps aux | grep "^root" | head -n 20

finding "Processes running as current user:"
ps aux | grep "^$(whoami)" | head -n 20

finding "All running processes:"
ps auxf 2>/dev/null | head -n 30

#############################################
# INTERESTING FILES
#############################################

section_header "INTERESTING FILES"

critical "Searching for passwords in files (this may take time):"
grep -r -i "password" /home/ 2>/dev/null | grep -v "Binary" | head -n 10

critical "SSH keys:"
find / -name "id_rsa" -o -name "id_dsa" -o -name "id_ed25519" 2>/dev/null

critical "SSH authorized_keys:"
find / -name "authorized_keys" 2>/dev/null

critical "History files:"
find /home -name ".*_history" 2>/dev/null
cat ~/.bash_history 2>/dev/null | tail -n 20

critical "Configuration files in /etc:"
ls -la /etc/*.conf 2>/dev/null | head -n 20

finding "Database files:"
find / -name "*.db" -o -name "*.sqlite" -o -name "*.sqlite3" 2>/dev/null | head -n 10

finding "Backup files:"
find / -name "*.bak" -o -name "*.backup" -o -name "*.old" 2>/dev/null | head -n 10

#############################################
# DEVELOPMENT TOOLS
#############################################

section_header "DEVELOPMENT TOOLS"

finding "Checking for compilers and interpreters:"
which gcc 2>/dev/null && gcc --version | head -n 1
which python 2>/dev/null && python --version 2>&1
which python3 2>/dev/null && python3 --version
which perl 2>/dev/null && perl --version | head -n 2
which ruby 2>/dev/null && ruby --version
which php 2>/dev/null && php --version | head -n 1
which go 2>/dev/null && go version
which java 2>/dev/null && java -version 2>&1 | head -n 1
which node 2>/dev/null && node --version

#############################################
# CAPABILITIES
#############################################

section_header "CAPABILITIES"

critical "Files with capabilities (potential privesc):"
getcap -r / 2>/dev/null || echo "getcap not available"

#############################################
# ENVIRONMENT VARIABLES
#############################################

section_header "ENVIRONMENT VARIABLES"

finding "PATH variable:"
echo $PATH

finding "All environment variables:"
env

finding "Checking for LD_PRELOAD or LD_LIBRARY_PATH:"
env | grep -i "LD_"

#############################################
# MOUNTED FILE SYSTEMS
#############################################

section_header "MOUNTED FILE SYSTEMS"

finding "Mount points:"
mount | column -t

finding "Disk usage:"
df -h

finding "Checking /etc/fstab:"
cat /etc/fstab 2>/dev/null

critical "NFS shares:"
cat /etc/exports 2>/dev/null

#############################################
# KERNEL EXPLOITS
#############################################

section_header "KERNEL EXPLOIT SUGGESTIONS"

finding "Kernel version: $(uname -r)"

warning "Potential kernel exploits (manual verification required):"
echo "  - DirtyCow (CVE-2016-5195): Kernel 2.6.22 < 3.9"
echo "  - PwnKit (CVE-2021-4034): Check pkexec version"
echo "  - Dirty Pipe (CVE-2022-0847): Kernel 5.8 - 5.16.11"
echo "  - Use linux-exploit-suggester.sh for automated checking"

#############################################
# RECOMMENDATIONS
#############################################

section_header "PRIVILEGE ESCALATION RECOMMENDATIONS"

echo -e "${YELLOW}Based on enumeration, check the following:${NC}"
echo ""
echo "1. ${GREEN}SUID/SGID Binaries:${NC} Look for exploitable SUID binaries in GTFOBins"
echo "2. ${GREEN}Sudo Permissions:${NC} Check sudo -l for binaries that can be exploited"
echo "3. ${GREEN}Writable Files:${NC} Check if you can modify system files or scripts"
echo "4. ${GREEN}Cron Jobs:${NC} Look for writable cron job scripts"
echo "5. ${GREEN}Kernel Exploits:${NC} Search for kernel version exploits"
echo "6. ${GREEN}Capabilities:${NC} Check for exploitable capabilities"
echo "7. ${GREEN}SSH Keys:${NC} Look for accessible private keys"
echo "8. ${GREEN}History Files:${NC} Search for credentials in bash history"
echo "9. ${GREEN}Configuration Files:${NC} Check for passwords in config files"
echo "10. ${GREEN}NFS Shares:${NC} Look for no_root_squash in /etc/exports"
echo ""

#############################################
# USEFUL COMMANDS
#############################################

section_header "USEFUL FOLLOW-UP COMMANDS"

echo -e "${CYAN}Manual enumeration commands:${NC}"
echo ""
echo "  # Find specific file types:"
echo "  find / -name '*.conf' 2>/dev/null"
echo "  find / -name '*.log' 2>/dev/null"
echo ""
echo "  # Search for passwords:"
echo "  grep -ri 'password' /var/www 2>/dev/null"
echo "  grep -ri 'pass' /etc 2>/dev/null"
echo ""
echo "  # Check for Docker:"
echo "  docker ps"
echo "  cat /var/run/docker.sock"
echo ""
echo "  # Check for LXD/LXC:"
echo "  lxc list"
echo "  lxd list"
echo ""
echo "  # Database enumeration:"
echo "  mysql -u root -p"
echo "  psql -U postgres"
echo ""

#############################################
# TOOLS RECOMMENDATION
#############################################

section_header "AUTOMATED TOOLS RECOMMENDATION"

echo -e "${GREEN}Consider using these automated tools:${NC}"
echo ""
echo "  • LinPEAS: https://github.com/carlospolop/PEASS-ng"
echo "  • LinEnum: https://github.com/rebootuser/LinEnum"
echo "  • Linux Exploit Suggester: https://github.com/mzet-/linux-exploit-suggester"
echo "  • pspy: https://github.com/DominicBreuker/pspy"
echo "  • GTFOBins: https://gtfobins.github.io/"
echo ""

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║             Enumeration Complete!                         ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${RED}⚠ Remember: Only perform privilege escalation on authorized systems!${NC}"
echo ""
