#!/bin/bash

################################################################################
# Linux Privilege Escalation Checker
# 
# Description: Automated Linux privilege escalation enumeration script
# Author: AlperKurtulus (TheJker)
# Usage: ./linux_privesc_check.sh
#
# Features:
#   - System information gathering
#   - User and group enumeration
#   - SUID/SGID binary identification
#   - Writable file/directory discovery
#   - Cron job analysis
#   - Network connection enumeration
#   - Running process analysis
#   - Capability enumeration
#   - Environment variable inspection
#   - Color-coded output with recommendations
################################################################################

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Banner
print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘      Linux Privilege Escalation Checker v1.0             â•‘"
    echo "â•‘              By: AlperKurtulus (TheJker)                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Print section header
print_section() {
    echo -e "\n${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${PURPLE}â–“â–“â–“ $1${NC}"
    echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# Print subsection
print_subsection() {
    echo -e "\n${CYAN}[+] $1${NC}"
}

# Print info
print_info() {
    echo -e "${BLUE}[*]${NC} $1"
}

# Print finding
print_finding() {
    echo -e "${YELLOW}[!]${NC} $1"
}

# Print critical finding
print_critical() {
    echo -e "${RED}[!!!]${NC} $1"
}

# Print success
print_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

# System Information
check_system_info() {
    print_section "SYSTEM INFORMATION"
    
    print_subsection "Hostname and OS Details"
    hostname 2>/dev/null
    cat /etc/issue 2>/dev/null | head -n 1
    cat /etc/*-release 2>/dev/null | grep -E "^(DISTRIB|PRETTY_NAME|NAME|VERSION)" | head -n 5
    uname -a 2>/dev/null
    
    print_subsection "Kernel Information"
    uname -r 2>/dev/null
    print_info "Check for kernel exploits: searchsploit linux kernel $(uname -r | cut -d'-' -f1)"
    
    print_subsection "CPU Information"
    lscpu 2>/dev/null | grep -E "^(Architecture|CPU|Model name)"
    
    print_subsection "Current User"
    whoami 2>/dev/null
    id 2>/dev/null
    
    print_subsection "Logged In Users"
    w 2>/dev/null
}

# User and Group Information
check_users_groups() {
    print_section "USER & GROUP ENUMERATION"
    
    print_subsection "Current User's Groups"
    groups 2>/dev/null
    
    print_subsection "All Users"
    cat /etc/passwd 2>/dev/null | cut -d: -f1 | column
    
    print_subsection "Users with Login Shell"
    cat /etc/passwd 2>/dev/null | grep -v "nologin\|false" | cut -d: -f1,7
    
    print_subsection "Super Users (UID=0)"
    awk -F: '($3 == "0") {print}' /etc/passwd 2>/dev/null
    
    print_subsection "Users with UID >= 1000 (Human users)"
    awk -F: '($3 >= 1000) {print $1 " (UID: " $3 ")"}' /etc/passwd 2>/dev/null
    
    print_subsection "Password Hashes"
    if [ -r /etc/shadow ]; then
        print_critical "READABLE /etc/shadow file!"
        cat /etc/shadow 2>/dev/null | head -n 5
    else
        print_info "/etc/shadow is not readable (expected)"
    fi
}

# Sudo Privileges
check_sudo() {
    print_section "SUDO PRIVILEGES"
    
    print_subsection "Sudo Version"
    sudo -V 2>/dev/null | head -n 1
    
    print_subsection "Sudo Privileges for Current User"
    sudo -l 2>/dev/null
    
    if sudo -l 2>/dev/null | grep -q "NOPASSWD"; then
        print_critical "Commands can be run with NOPASSWD!"
        sudo -l 2>/dev/null | grep "NOPASSWD"
    fi
    
    print_subsection "Sudoers File"
    if [ -r /etc/sudoers ]; then
        print_finding "Can read /etc/sudoers file!"
        cat /etc/sudoers 2>/dev/null | grep -v "^#" | grep -v "^$"
    fi
}

# SUID and SGID Binaries
check_suid_sgid() {
    print_section "SUID & SGID BINARIES"
    
    print_subsection "SUID Binaries (Owned by root)"
    print_info "Finding SUID binaries... (this may take a moment)"
    find / -perm -4000 -type f -user root 2>/dev/null
    
    print_subsection "Uncommon SUID Binaries (Potential Exploits)"
    COMMON_SUID="su sudo passwd mount umount fusermount ping ping6 chfn chsh"
    for binary in $(find / -perm -4000 -type f 2>/dev/null); do
        basename_bin=$(basename "$binary")
        if ! echo "$COMMON_SUID" | grep -qw "$basename_bin"; then
            print_finding "$binary"
        fi
    done
    
    print_subsection "SGID Binaries"
    find / -perm -2000 -type f 2>/dev/null | head -n 20
    
    print_info "Check GTFOBins for exploitation: https://gtfobins.github.io/"
}

# Writable Files and Directories
check_writable() {
    print_section "WRITABLE FILES & DIRECTORIES"
    
    print_subsection "World-Writable Directories"
    print_info "Finding world-writable directories... (this may take a moment)"
    find / -type d -perm -0002 2>/dev/null | grep -v "proc\|sys\|run" | head -n 20
    
    print_subsection "World-Writable Files"
    find / -type f -perm -0002 2>/dev/null | grep -v "proc\|sys\|run" | head -n 20
    
    print_subsection "Writable /etc Files"
    find /etc -writable -type f 2>/dev/null
    
    print_subsection "Writable Scripts in /etc/init.d"
    find /etc/init.d -writable 2>/dev/null
}

# Cron Jobs
check_cron() {
    print_section "SCHEDULED TASKS (CRON JOBS)"
    
    print_subsection "User Crontab"
    crontab -l 2>/dev/null
    
    print_subsection "System-wide Cron Jobs"
    cat /etc/crontab 2>/dev/null
    
    print_subsection "Cron Jobs in /etc/cron.d"
    ls -la /etc/cron.d 2>/dev/null
    cat /etc/cron.d/* 2>/dev/null
    
    print_subsection "Cron Jobs by Frequency"
    for dir in /etc/cron.hourly /etc/cron.daily /etc/cron.weekly /etc/cron.monthly; do
        if [ -d "$dir" ]; then
            echo -e "\n${BLUE}$dir:${NC}"
            ls -la "$dir" 2>/dev/null
        fi
    done
    
    print_subsection "Writable Cron Scripts"
    for script in /etc/cron.*/*; do
        if [ -w "$script" ] 2>/dev/null; then
            print_finding "Writable: $script"
        fi
    done
}

# Network Information
check_network() {
    print_section "NETWORK INFORMATION"
    
    print_subsection "Network Interfaces"
    ip addr 2>/dev/null || ifconfig 2>/dev/null
    
    print_subsection "Routing Table"
    ip route 2>/dev/null || route 2>/dev/null
    
    print_subsection "ARP Table"
    ip neigh 2>/dev/null || arp -a 2>/dev/null
    
    print_subsection "Network Connections"
    netstat -antup 2>/dev/null || ss -antup 2>/dev/null
    
    print_subsection "Listening Ports"
    netstat -tulpn 2>/dev/null | grep LISTEN || ss -tulpn 2>/dev/null | grep LISTEN
    
    print_subsection "DNS Configuration"
    cat /etc/resolv.conf 2>/dev/null
    
    print_subsection "Hosts File"
    cat /etc/hosts 2>/dev/null | grep -v "^#"
}

# Running Processes
check_processes() {
    print_section "RUNNING PROCESSES"
    
    print_subsection "Processes Run by Root"
    ps aux 2>/dev/null | grep "^root" | head -n 20
    
    print_subsection "Current User Processes"
    ps aux 2>/dev/null | grep "^$(whoami)" | head -n 20
    
    print_subsection "All Running Processes"
    ps auxf 2>/dev/null | head -n 30
}

# Interesting Files
check_interesting_files() {
    print_section "INTERESTING FILES"
    
    print_subsection "SSH Keys"
    find / -name "id_rsa" -o -name "id_dsa" -o -name "authorized_keys" 2>/dev/null
    
    print_subsection "Configuration Files in Home Directory"
    find /home -name "*.conf" -o -name "*.config" 2>/dev/null | head -n 20
    
    print_subsection "Database Files"
    find / -name "*.db" -o -name "*.sqlite" -o -name "*.sql" 2>/dev/null | grep -v "proc\|sys" | head -n 20
    
    print_subsection "Backup Files"
    find / -name "*.bak" -o -name "*.backup" -o -name "*~" 2>/dev/null | grep -v "proc\|sys" | head -n 20
    
    print_subsection "Log Files (Readable)"
    find /var/log -type f -readable 2>/dev/null | head -n 20
    
    print_subsection "History Files"
    find /home -name ".*history" 2>/dev/null
    cat ~/.*history 2>/dev/null | tail -n 50
}

# Capabilities
check_capabilities() {
    print_section "CAPABILITIES"
    
    print_subsection "Files with Capabilities"
    print_info "Searching for files with capabilities..."
    getcap -r / 2>/dev/null
    
    print_info "Check for capability-based exploits: https://gtfobins.github.io/"
}

# Environment Variables
check_environment() {
    print_section "ENVIRONMENT VARIABLES"
    
    print_subsection "Environment Variables"
    env 2>/dev/null | sort
    
    print_subsection "PATH Variable"
    echo "$PATH"
    
    print_subsection "Writable PATH Directories"
    for dir in $(echo "$PATH" | tr ':' ' '); do
        if [ -w "$dir" ] 2>/dev/null; then
            print_finding "Writable: $dir"
        fi
    done
}

# Software and Packages
check_software() {
    print_section "INSTALLED SOFTWARE"
    
    print_subsection "Development Tools"
    which gcc g++ python python3 perl ruby php 2>/dev/null
    
    print_subsection "Useful Programs"
    which nc netcat wget curl socat python python3 perl ruby 2>/dev/null
    
    print_subsection "Installed Packages (Sample)"
    if command -v dpkg &> /dev/null; then
        dpkg -l 2>/dev/null | head -n 30
    elif command -v rpm &> /dev/null; then
        rpm -qa 2>/dev/null | head -n 30
    fi
}

# Recommendations
print_recommendations() {
    print_section "PRIVILEGE ESCALATION RECOMMENDATIONS"
    
    echo -e "${CYAN}Based on the enumeration, check the following:${NC}\n"
    
    print_info "1. Kernel Exploits - Check kernel version against known exploits"
    print_info "2. SUID/SGID Binaries - Review uncommon SUID binaries on GTFOBins"
    print_info "3. Sudo Privileges - Exploit NOPASSWD commands"
    print_info "4. Cron Jobs - Check for writable scripts or PATH hijacking"
    print_info "5. Writable Files - Look for writable /etc files or service configs"
    print_info "6. Capabilities - Check files with special capabilities"
    print_info "7. NFS - Check for no_root_squash in /etc/exports"
    print_info "8. Docker/LXC - Check if inside container with escape possibilities"
    print_info "9. SSH Keys - Look for private keys with weak permissions"
    print_info "10. Passwords - Search config files and history for credentials"
    
    echo -e "\n${YELLOW}Useful Resources:${NC}"
    print_info "GTFOBins: https://gtfobins.github.io/"
    print_info "Linux PrivEsc Checklist: https://book.hacktricks.xyz/linux-unix/privilege-escalation"
    print_info "PayloadsAllTheThings: https://github.com/swisskyrepo/PayloadsAllTheThings"
}

# Main function
main() {
    print_banner
    
    print_success "Starting Linux Privilege Escalation Enumeration..."
    print_info "This script will enumerate potential privilege escalation vectors"
    
    # Run all checks
    check_system_info
    check_users_groups
    check_sudo
    check_suid_sgid
    check_writable
    check_cron
    check_network
    check_processes
    check_interesting_files
    check_capabilities
    check_environment
    check_software
    
    # Print recommendations
    print_recommendations
    
    print_section "ENUMERATION COMPLETE"
    print_success "Review the output above for potential privilege escalation vectors"
    print_info "Remember: Always obtain proper authorization before exploiting"
    
    echo -e "\n${GREEN}Happy Hunting! ðŸŽ¯${NC}\n"
}

# Run main function
main
